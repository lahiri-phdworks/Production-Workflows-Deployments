name: terraform-deploy

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: read

env:
  TF_WORKING_DIR: infra
  SSH_REMOTE_USER: ubuntu # Ubuntu 22.04 default user

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform init / plan / apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform init
          terraform fmt -check
          terraform validate
          terraform plan -out=tfplan
          terraform apply -auto-approve tfplan

      - name: Capture Terraform outputs
        id: tf_outputs
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform output -json > tf-outputs.json
          echo "public_ips=$(jq -r '.instance_public_ips.value[]' tf-outputs.json | paste -sd ' ' -)" >> $GITHUB_OUTPUT
          echo "app_user=$(jq -r '.app_user.value' tf-outputs.json)" >> $GITHUB_OUTPUT
          echo "app_port=$(jq -r '.app_port.value' tf-outputs.json)" >> $GITHUB_OUTPUT

      - name: Build app artifact
        run: |
          python -m venv .venv
          .venv/bin/pip install --upgrade pip
          if [ -f requirements.txt ]; then .venv/bin/pip install -r requirements.txt; fi
          tar czf app.tar.gz --exclude='.git' --exclude='.github' .

      - name: Deploy to EC2 instances
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          set -e
          eval "$(ssh-agent -s)"
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
          for ip in ${{ steps.tf_outputs.outputs.public_ips }}; do
            scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null app.tar.gz ${SSH_REMOTE_USER}@"$ip":/opt/fastapi-app/
            ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${SSH_REMOTE_USER}@"$ip" <<'EOF'
              set -e
              sudo systemctl stop fastapi.service || true
              cd /opt/fastapi-app
              tar xzf app.tar.gz
              if [ ! -d .venv ]; then python3 -m venv .venv; fi
              ./.venv/bin/pip install --upgrade pip
              if [ -f requirements.txt ]; then ./.venv/bin/pip install -r requirements.txt; fi
              sudo systemctl daemon-reload
              sudo systemctl restart fastapi.service
            EOF
          done
